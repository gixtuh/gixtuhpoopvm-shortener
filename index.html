<head>
    <title>gixtuh's public vm if anyone wants</title>
    <style>
        body {
            background-color: gray;
            text-align: center;
            font-family: Arial, Helvetica, sans-serif;
        }
        iframe {
            justify-self: center;
            margin-top: 40px;
            display: flex;
            border: none;
            border-radius: 10px;
            width: 100%;
            height: 70%;
        }
        #chat-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #chat {
            width: 90%;
            height: 400px;
            border: none;
            padding: 10px;
            overflow-y: scroll;
            background-color: #111;
            color: white;
            border-radius: 8px;
            line-height: 3;
        }
        #chat > div:hover {
            display: flex;
            background-color: #303030;
            border-radius: 20px;
            padding-left: 20px;
            transition-duration: 0.3s;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-60px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        #chat > div {
            display: flex;
            transition-duration: 1s;
            animation: slideIn 0.5s;
        }
        #message {
            width: 70%;
            padding: 8px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
        }
        button {
            border: none;
            border-radius: 5px;
            background-color: rgb(102, 102, 102);
            color: rgb(204, 204, 204);
            padding: 15px;
            transition-duration: 1s;
        }
        button:hover {
            background-color: rgb(78, 78, 78);
            transition-duration: 0.3s;
        }
        button:active {
            background-color: rgb(44, 44, 44)
        }
        p {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>gixtuh's great vm</h1>
    <p>a really great vnc with a virtual machine</p> <br />
    <button onclick="window.location.href = 'https://novnc.com/noVNC/vnc.html?autoconnect=1&host=gixtuhgreatvm.serveousercontent.com&port=443&resize=scale&reconnect=1&path=&reconnect_delay=0'">embed</button>
    <button id="rebootBtn">reboot</button>
    
    <script>
        let dataaction = undefined
        document.getElementById('rebootBtn').addEventListener('click', async () => {
            const secretJson = await new Promise(resolve => {
                ws.send(JSON.stringify({
                    room: 'gixtuhgreatvm',
                    message: 'hidden',
                    action: 'reboot'
                }));
                const timeout = setTimeout(() => {
                    ws.removeEventListener('message', handler);
                    resolve(null); // timeout
                }, 1000);
                
                const handler = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (
                        data.room === "gixtuhgreatvm" &&
                        data.message === "hidden" &&
                        data.action === "code" ||
                        
                        data.room === "gixtuhgreatvm" &&
                        data.message === "hidden" &&
                        data.action === "rebootSuccessful" ||

                        data.room === "gixtuhgreatvm" &&
                        data.message === "hidden" &&
                        data.action === "codeTimeout"
                        ) {
                            dataaction = data.action
                            clearTimeout(timeout);
                            ws.removeEventListener('message', handler);
                            resolve(data);
                        }
                    } catch (err) {}
                };
                
                ws.addEventListener('message', handler);
            });
            
            if (secretJson) {
                if (dataaction === "code") {
                    const code = prompt("enter 4 digit code to reboot:");
                    if (code) {
                        ws.send(JSON.stringify({
                            room: 'gixtuhgreatvm',
                            message: 'hidden',
                            action: 'reboot',
                            code: code
                        }));
                    }
                } else if (dataaction === "codeTimeout") {
                    const code = prompt("reboot option is on cooldown, enter 4 digit code to reboot:");
                    if (code) {
                        ws.send(JSON.stringify({
                            room: 'gixtuhgreatvm',
                            message: 'hidden',
                            action: 'reboot',
                            code: code
                        }));
                    }
                }
            } else {
                alert("Error while rebooting: Server gave no response.\nMost likely caused by:\n 1: Server is offline\n 2: Virtual machine is OFF\n 3: You've been disconnected off the chat servers. (they handle packet sharing)\n 4: Servers disconnected off the chat servers.\n\nRefresh the page to try reconnecting to the servers")
            }
        });
        </script>
        
        <hr />
        <iframe id="iframething" width="700" height="450" src="https://novnc.com/noVNC/vnc.html?autoconnect=1&host=gixtuhgreatvm.serveousercontent.com&port=443&resize=scale&reconnect=1&path=&reconnect_delay=0" allowfullscreen></iframe>
        
        <br />
        
        <div id="chat-container">
            <div id="chat"></div>
            <input id="message" type="text" placeholder="enter a message" />
        </div>
        <button onclick="changeuser()">change username</button>
        <audio id="notif" src="./message.wav"></audio>
        
        <script>
            const chatDiv = document.getElementById('chat');
            const input = document.getElementById('message');
            
            
            let user = localStorage.getItem("username") ?? `Guest${Math.round(Math.random() * 89999999 + 10000000)}`
            console.log(user)
            const ws = new WebSocket('wss://gixtuhgreatvm-chat.serveousercontent.com', user);
            
            function changeuser() {
                user = prompt("which username")
                if (user == "" || user == undefined || user.length > 15) {
                    user = `Guest${Math.round(Math.random() * 89999999 + 10000000)}`
                    alert("Your username has been reset.\nYour username cannot have more than 15 letters and cant be nothing.")
                } else {
                    localStorage.setItem("username", user.replace(" ", "_"))
                    window.location.href = window.location.href
                }
            }
            
            ws.addEventListener('open', () => appendMessage('connected to chat servers'));
            ws.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.room === 'gixtuhgreatvm') {
                        if (data.message !== "hidden" && data.user !== undefined) {
                            appendMessage(data.user ? `${data.user}: ${data.message}` : data.message);
                            document.getElementById("notif").play()
                        }
                    }
                } catch (err) { 
                    console.error('Invalid JSON', err);
                }
            });
            ws.addEventListener('close', (event) => {
                console.log(event.reason);
		console.log(event.code)
                if (event.reason !== "") {
                    appendMessage("------------------------------------------------------------------------------------");
                    appendMessage(`sadly you've been kicked ou- ${event.reason}`)
                } else {
                    appendMessage("------------------------------------------------------------------------------------");
                    appendMessage(`sadly you've been kicked out because the servers are offline :(`)
                }
                document.getElementById("iframething").src = "./banned.html"
            });
            ws.addEventListener('error', () => appendMessage('error'));
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    const msg = { room: 'gixtuhgreatvm', message: input.value.trim(), user: user };
                    ws.send(JSON.stringify(msg));
                    input.value = '';
                }
            });
            
            function appendMessage(text) {
                const msg = document.createElement('div');
                msg.textContent = text;
                chatDiv.appendChild(msg);
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }
        </script>
        
    </body>